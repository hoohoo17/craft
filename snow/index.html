<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>â„ï¸ Snow Craft - ìŠ¤ë…¸ìš° í¬ë˜í”„íŠ¸</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0a1628;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
    }
    #gameContainer {
      position: relative;
      width: 100%;
      max-width: 400px;
      height: 100vh;
      max-height: 700px;
      overflow: hidden;
      touch-action: none;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
    #ui {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    #ui > * { pointer-events: auto; }
    
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, #0a1628 0%, #1e3a5f 50%, #2a5080 100%);
      transition: opacity 0.5s;
    }
    .hidden { opacity: 0; pointer-events: none !important; }
    
    #titleScreen h1 {
      font-size: 42px;
      color: #fff;
      text-shadow: 0 0 20px #5eb8ff;
      margin-bottom: 10px;
    }
    #titleScreen h2 {
      font-size: 24px;
      color: #5eb8ff;
      margin-bottom: 40px;
    }
    .btn {
      background: linear-gradient(135deg, #5eb8ff, #2a8cd4);
      border: none;
      color: #fff;
      padding: 15px 50px;
      font-size: 20px;
      border-radius: 30px;
      cursor: pointer;
      margin: 10px;
      box-shadow: 0 5px 20px rgba(94, 184, 255, 0.4);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover { transform: scale(1.05); box-shadow: 0 8px 30px rgba(94, 184, 255, 0.6); }
    .btn:active { transform: scale(0.95); }
    
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      justify-content: space-between;
      color: #fff;
      font-size: 14px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    #hud > div {
      background: rgba(0,0,0,0.3);
      padding: 8px 15px;
      border-radius: 20px;
    }
    
    #phaseIndicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 28px;
      color: #fff;
      text-shadow: 0 0 20px #5eb8ff;
      opacity: 0;
      transition: opacity 0.3s;
    }
    #phaseIndicator.show { opacity: 1; }
    
    #growthControls {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
    }
    .growBtn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(94, 184, 255, 0.3);
      border: 2px solid #5eb8ff;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.1s;
    }
    .growBtn:active {
      background: rgba(94, 184, 255, 0.8);
      transform: scale(0.9);
    }
    
    #tapZone {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      color: #fff;
    }
    #tapZone .tap-text {
      font-size: 18px;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    #skipBtn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
      padding: 8px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }
    
    #resultScreen {
      background: linear-gradient(180deg, #1a365d 0%, #2c5282 100%);
      padding: 20px;
      text-align: center;
    }
    #resultScreen h2 {
      font-size: 32px;
      color: #fff;
      margin-bottom: 20px;
    }
    .result-snowflake {
      font-size: 80px;
      margin: 20px 0;
    }
    .result-stats {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
      color: #fff;
    }
    .result-stats div {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      font-size: 16px;
    }
    .result-total {
      font-size: 28px;
      color: #5eb8ff;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.2);
    }
    
    #progressBar {
      position: absolute;
      bottom: 10px;
      left: 20px;
      right: 20px;
      height: 8px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }
    #progressFill {
      height: 100%;
      background: linear-gradient(90deg, #5eb8ff, #00d4aa);
      border-radius: 4px;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui">
      <!-- íƒ€ì´í‹€ í™”ë©´ -->
      <div id="titleScreen" class="screen">
        <div style="font-size: 60px; margin-bottom: 20px;">â„ï¸</div>
        <h1>SNOW CRAFT</h1>
        <h2>ìŠ¤ë…¸ìš° í¬ë˜í”„íŠ¸</h2>
        <button class="btn" id="startBtn">â–¶ ì‹œì‘í•˜ê¸°</button>
        <p style="color: #8eb8dc; margin-top: 30px; font-size: 14px;">ë¬¼ì´ì˜ ì—¬ì •ì„ í•¨ê»˜í•´ìš”!</p>
      </div>
      
      <!-- ì—í”¼ì†Œë“œ í™”ë©´ -->
      <div id="episodeScreen" class="screen hidden">
        <div id="episodeContent" style="text-align: center; padding: 40px;">
          <div id="episodeEmoji" style="font-size: 80px; margin-bottom: 20px;"></div>
          <p id="episodeText" style="color: #fff; font-size: 20px; line-height: 1.6;"></p>
        </div>
        <button id="skipBtn">SKIP â†’</button>
      </div>
      
      <!-- ê²Œì„ HUD -->
      <div id="hud" class="hidden">
        <div id="altitudeDisplay">ğŸŒ¡ï¸ <span id="altitude">0</span>m</div>
        <div id="phaseDisplay">ğŸ’§ ìƒìŠ¹</div>
        <div id="scoreDisplay">â­ <span id="score">0</span></div>
      </div>
      
      <div id="phaseIndicator"></div>
      
      <!-- ì„±ì¥ ì»¨íŠ¸ë¡¤ -->
      <div id="growthControls" class="hidden">
        <button class="growBtn" data-dir="left">â†–ï¸</button>
        <button class="growBtn" data-dir="up">â¬†ï¸</button>
        <button class="growBtn" data-dir="right">â†—ï¸</button>
      </div>
      
      <!-- íƒ­ ì¡´ -->
      <div id="tapZone" class="hidden">
        <div class="tap-text">ğŸ‘† íƒ­í•˜ì—¬ ê²°í•©!</div>
      </div>
      
      <div id="progressBar" class="hidden">
        <div id="progressFill" style="width: 0%"></div>
      </div>
      
      <!-- ê²°ê³¼ í™”ë©´ -->
      <div id="resultScreen" class="screen hidden">
        <h2>â„ï¸ ì—¬ì • ì™„ë£Œ! â„ï¸</h2>
        <div class="result-snowflake" id="resultSnowflake">â„ï¸</div>
        <p id="resultType" style="color: #5eb8ff; font-size: 18px;"></p>
        <div class="result-stats">
          <div><span>ì—ë„ˆì§€ ìˆ˜ì§‘</span><span id="resultEnergy">+0</span></div>
          <div><span>ê²°í•© ë³´ë„ˆìŠ¤</span><span id="resultBond">+0</span></div>
          <div><span>ëˆˆì†¡ì´ ì„±ì¥</span><span id="resultGrowth">+0</span></div>
          <div><span>ì°©ì§€ ë³´ë„ˆìŠ¤</span><span id="resultLanding">x1.0</span></div>
          <div class="result-total"><span>ì´ì </span><span id="resultTotal">0</span></div>
        </div>
        <button class="btn" id="retryBtn">ğŸ”„ ë‹¤ì‹œ í•˜ê¸°</button>
      </div>
    </div>
  </div>

<script>
// ============== ê²Œì„ ì„¤ì • ==============
const CONFIG = {
  PHASE_RISING: { duration: 30000, maxAltitude: 5000 },
  PHASE_BOND: { duration: 5000 },
  PHASE_GROWTH: { duration: 10000 },
  PHASE_FALLING: { duration: 15000 },
};

// ============== ê²Œì„ ìƒíƒœ ==============
const game = {
  canvas: null,
  ctx: null,
  width: 400,
  height: 700,
  phase: 'title', // title, episode, rising, bond, growth, falling, result
  time: 0,
  altitude: 0,
  score: 0,
  energy: 0,
  bondBonus: 0,
  growthScore: 0,
  landingZone: null,
  snowflake: { branches: [], size: 0, type: 'basic' },
  player: { x: 200, y: 500, vy: 0, form: 'drop' }, // drop, vapor, crystal, snowflake
  particles: [],
  obstacles: [],
  dustParticles: [],
  windForce: 0,
  keys: { left: false, right: false, up: false, down: false },
  touch: { startX: 0, currentX: 0, active: false },
  phaseStartTime: 0,
  animationId: null,
};

// ============== ì—í”¼ì†Œë“œ ë°ì´í„° ==============
const episodes = [
  { emoji: 'â˜€ï¸ğŸ’§', text: 'ì™€ì•„~ ë”°ëœ»í•´!\nëª¸ì´ ë‘¥ë‘¥ ë– ì˜¤ë¥¸ë‹¤!' },
  { emoji: 'âš«ğŸ’¨', text: 'ìš°ì™€! ë¨¼ì§€ê°€ ìˆë„¤?\nì–´... ë¶™ëŠ”ë‹¤! ì² ì©!' },
  { emoji: 'â„ï¸ğŸ’¨', text: 'ì˜¤! ê²¨ìš¸ì´ë„¤? ì–¸ë‹¤!\në–¨ì–´ì§„ë‹¤... ê½!\në°”ëŒ ë•Œë¬¸ì— ìŠˆì›…~' },
  { emoji: 'ğŸŒŠğŸ’§', text: 'ë°”ë‹¤ì— í’ë©!\në‹¤ì‹œ ì‹œì‘ì´ë„¤~ í—¤í—¤' },
];
let episodeIndex = 0;

// ============== ì´ˆê¸°í™” ==============
function init() {
  game.canvas = document.getElementById('gameCanvas');
  game.ctx = game.canvas.getContext('2d');
  
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
  
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  document.getElementById('startBtn').addEventListener('click', startEpisode);
  document.getElementById('skipBtn').addEventListener('click', skipEpisode);
  document.getElementById('retryBtn').addEventListener('click', restartGame);
  
  // í‚¤ë³´ë“œ
  document.addEventListener('keydown', e => {
    if (e.key === 'ArrowLeft') game.keys.left = true;
    if (e.key === 'ArrowRight') game.keys.right = true;
    if (e.key === 'ArrowUp') game.keys.up = true;
    if (e.key === 'ArrowDown') game.keys.down = true;
    if (e.key === ' ' && game.phase === 'bond') handleTap();
    // ì„±ì¥ Phaseì—ì„œ ë°©í–¥í‚¤ë¡œ ì¡°ì‘
    if (game.phase === 'growth') {
      if (e.key === 'ArrowLeft') handleGrowth('left');
      if (e.key === 'ArrowUp') handleGrowth('up');
      if (e.key === 'ArrowRight') handleGrowth('right');
    }
    e.preventDefault();
  });
  document.addEventListener('keyup', e => {
    if (e.key === 'ArrowLeft') game.keys.left = false;
    if (e.key === 'ArrowRight') game.keys.right = false;
    if (e.key === 'ArrowUp') game.keys.up = false;
    if (e.key === 'ArrowDown') game.keys.down = false;
  });
  
  // í„°ì¹˜/ë§ˆìš°ìŠ¤
  game.canvas.addEventListener('touchstart', handleTouchStart);
  game.canvas.addEventListener('touchmove', handleTouchMove);
  game.canvas.addEventListener('touchend', handleTouchEnd);
  game.canvas.addEventListener('mousedown', handleMouseDown);
  game.canvas.addEventListener('mousemove', handleMouseMove);
  game.canvas.addEventListener('mouseup', handleMouseUp);
  game.canvas.addEventListener('click', () => {
    if (game.phase === 'bond') handleTap();
  });
  
  // ì„±ì¥ ë²„íŠ¼
  document.querySelectorAll('.growBtn').forEach(btn => {
    btn.addEventListener('click', () => handleGrowth(btn.dataset.dir));
    btn.addEventListener('touchstart', (e) => {
      e.preventDefault();
      handleGrowth(btn.dataset.dir);
    });
  });
  
  gameLoop();
}

function resizeCanvas() {
  const container = document.getElementById('gameContainer');
  game.width = container.clientWidth;
  game.height = container.clientHeight;
  game.canvas.width = game.width;
  game.canvas.height = game.height;
  game.player.x = game.width / 2;
}

// ============== ì—í”¼ì†Œë“œ ==============
function startEpisode() {
  document.getElementById('titleScreen').classList.add('hidden');
  document.getElementById('episodeScreen').classList.remove('hidden');
  episodeIndex = 0;
  showEpisode();
}

function showEpisode() {
  if (episodeIndex >= episodes.length) {
    skipEpisode();
    return;
  }
  const ep = episodes[episodeIndex];
  document.getElementById('episodeEmoji').textContent = ep.emoji;
  document.getElementById('episodeText').textContent = ep.text;
  
  setTimeout(() => {
    episodeIndex++;
    showEpisode();
  }, 2500);
}

function skipEpisode() {
  document.getElementById('episodeScreen').classList.add('hidden');
  startGame();
}

// ============== ê²Œì„ ì‹œì‘ ==============
function startGame() {
  game.phase = 'rising';
  game.time = 0;
  game.altitude = 0;
  game.score = 0;
  game.energy = 0;
  game.bondBonus = 0;
  game.growthScore = 0;
  game.snowflake = { branches: [], size: 0, type: 'basic' };
  game.player = { x: game.width / 2, y: game.height * 0.7, vy: 0, form: 'vapor' };
  game.particles = [];
  game.obstacles = [];
  game.dustParticles = [];
  game.phaseStartTime = Date.now();
  
  document.getElementById('hud').classList.remove('hidden');
  document.getElementById('progressBar').classList.remove('hidden');
  
  showPhaseIndicator('ğŸ’¨ ìƒìŠ¹!');
  spawnInitialObjects();
}

function restartGame() {
  document.getElementById('resultScreen').classList.add('hidden');
  document.getElementById('titleScreen').classList.remove('hidden');
  document.getElementById('hud').classList.add('hidden');
  document.getElementById('progressBar').classList.add('hidden');
  game.phase = 'title';
}

// ============== í„°ì¹˜/ë§ˆìš°ìŠ¤ í•¸ë“¤ëŸ¬ ==============
function handleTouchStart(e) {
  e.preventDefault();
  const touch = e.touches[0];
  game.touch.startX = touch.clientX;
  game.touch.currentX = touch.clientX;
  game.touch.active = true;
}

function handleTouchMove(e) {
  e.preventDefault();
  if (game.touch.active) {
    game.touch.currentX = e.touches[0].clientX;
  }
}

function handleTouchEnd(e) {
  e.preventDefault();
  game.touch.active = false;
}

function handleMouseDown(e) {
  game.touch.startX = e.clientX;
  game.touch.currentX = e.clientX;
  game.touch.active = true;
}

function handleMouseMove(e) {
  if (game.touch.active) {
    game.touch.currentX = e.clientX;
  }
}

function handleMouseUp() {
  game.touch.active = false;
}

// ============== ê²Œì„ í•¸ë“¤ëŸ¬ ==============
function handleTap() {
  if (game.phase !== 'bond') return;
  
  // ê°€ì¥ ê°€ê¹Œìš´ ë¨¼ì§€ ì°¾ê¸°
  let closest = null;
  let minDist = Infinity;
  
  game.dustParticles.forEach(d => {
    const dist = Math.abs(d.x - game.player.x);
    if (dist < minDist) {
      minDist = dist;
      closest = d;
    }
  });
  
  if (closest && minDist < 80) {
    // Perfect or Good
    if (minDist < 30) {
      game.bondBonus = 500;
      showPhaseIndicator('â­ PERFECT!');
    } else {
      game.bondBonus = 200;
      showPhaseIndicator('ğŸ‘ GOOD!');
    }
    game.player.form = 'crystal';
    startGrowthPhase();
  }
}

function handleGrowth(dir) {
  if (game.phase !== 'growth') return;
  
  const angle = dir === 'left' ? -30 : dir === 'right' ? 30 : 0;
  game.snowflake.branches.push({
    angle: angle + (Math.random() - 0.5) * 20,
    length: 5 + Math.random() * 10,
  });
  game.snowflake.size += 2;
  game.growthScore += 30;
  
  // íŒŒí‹°í´ íš¨ê³¼
  for (let i = 0; i < 3; i++) {
    game.particles.push({
      x: game.player.x + (Math.random() - 0.5) * 40,
      y: game.player.y + (Math.random() - 0.5) * 40,
      vx: (Math.random() - 0.5) * 2,
      vy: (Math.random() - 0.5) * 2,
      life: 30,
      type: 'sparkle',
    });
  }
}

// ============== Phase ì „í™˜ ==============
function showPhaseIndicator(text) {
  const indicator = document.getElementById('phaseIndicator');
  indicator.textContent = text;
  indicator.classList.add('show');
  setTimeout(() => indicator.classList.remove('show'), 1500);
}

function startBondPhase() {
  game.phase = 'bond';
  game.phaseStartTime = Date.now();
  document.getElementById('phaseDisplay').textContent = 'âš« ì‘ê²°';
  document.getElementById('tapZone').classList.remove('hidden');
  showPhaseIndicator('âš« ë¨¼ì§€ì™€ ê²°í•©!');
  
  // ë¨¼ì§€ ìƒì„±
  game.dustParticles = [];
  for (let i = 0; i < 5; i++) {
    game.dustParticles.push({
      x: 50 + i * 80,
      y: game.height * 0.3 + Math.random() * 100,
      quality: i === 2 ? 'perfect' : 'normal',
      vx: (Math.random() - 0.5) * 2,
    });
  }
}

function startGrowthPhase() {
  game.phase = 'growth';
  game.phaseStartTime = Date.now();
  document.getElementById('phaseDisplay').textContent = 'â„ï¸ ì„±ì¥';
  document.getElementById('tapZone').classList.add('hidden');
  document.getElementById('growthControls').classList.remove('hidden');
  showPhaseIndicator('â„ï¸ ëˆˆì†¡ì´ ì„±ì¥!');
  game.player.form = 'snowflake';
}

function startFallingPhase() {
  game.phase = 'falling';
  game.phaseStartTime = Date.now();
  document.getElementById('phaseDisplay').textContent = 'â¬‡ï¸ ë‚™í•˜';
  document.getElementById('growthControls').classList.add('hidden');
  showPhaseIndicator('â¬‡ï¸ ë‚™í•˜ ì‹œì‘!');
  game.player.y = 100;
  game.altitude = 5000;
  
  // ëˆˆì†¡ì´ íƒ€ì… ê²°ì •
  const branchCount = game.snowflake.branches.length;
  if (branchCount > 20) game.snowflake.type = 'stellar';
  else if (branchCount > 10) game.snowflake.type = 'dendrite';
  else game.snowflake.type = 'plate';
}

function endGame(zone) {
  game.phase = 'result';
  game.landingZone = zone;
  
  document.getElementById('hud').classList.add('hidden');
  document.getElementById('progressBar').classList.add('hidden');
  
  // ì ìˆ˜ ê³„ì‚°
  const multipliers = { mountain: 1.0, lake: 1.5, forest: 1.2, village: 2.0 };
  const multiplier = multipliers[zone] || 1.0;
  const total = Math.floor((1000 + game.energy * 10 + game.bondBonus + game.growthScore) * multiplier);
  
  // ê²°ê³¼ í‘œì‹œ
  document.getElementById('resultSnowflake').textContent = 'â„ï¸';
  document.getElementById('resultType').textContent = `íƒ€ì…: ${game.snowflake.type} | í¬ê¸°: ${game.snowflake.size > 30 ? 'ëŒ€í˜•' : 'ì¤‘í˜•'}`;
  document.getElementById('resultEnergy').textContent = `+${game.energy * 10}`;
  document.getElementById('resultBond').textContent = `+${game.bondBonus}${game.bondBonus === 500 ? ' (PERFECT!)' : ''}`;
  document.getElementById('resultGrowth').textContent = `+${game.growthScore}`;
  document.getElementById('resultLanding').textContent = `x${multiplier} (${zone})`;
  document.getElementById('resultTotal').textContent = total;
  
  setTimeout(() => {
    document.getElementById('resultScreen').classList.remove('hidden');
  }, 500);
}

// ============== ì˜¤ë¸Œì íŠ¸ ìƒì„± ==============
function spawnInitialObjects() {
  // ì—ë„ˆì§€ íŒŒí‹°í´
  for (let i = 0; i < 20; i++) {
    game.particles.push(createEnergyParticle());
  }
  // ì¥ì• ë¬¼
  for (let i = 0; i < 5; i++) {
    game.obstacles.push(createObstacle());
  }
}

function createEnergyParticle() {
  return {
    x: Math.random() * game.width,
    y: Math.random() * game.height * 0.6,
    vx: (Math.random() - 0.5) * 0.5,
    vy: (Math.random() - 0.5) * 0.5,
    life: 999,
    type: 'energy',
  };
}

function createObstacle() {
  const types = ['bird', 'plane', 'downdraft'];
  return {
    x: Math.random() * game.width,
    y: Math.random() * game.height * 0.5,
    vx: (Math.random() - 0.5) * 3,
    type: types[Math.floor(Math.random() * types.length)],
  };
}

// ============== ì—…ë°ì´íŠ¸ ==============
function update() {
  if (game.phase === 'title' || game.phase === 'episode' || game.phase === 'result') return;
  
  const elapsed = Date.now() - game.phaseStartTime;
  
  // í”Œë ˆì´ì–´ ì´ë™
  let moveX = 0;
  let moveY = 0;
  if (game.keys.left) moveX = -5;
  if (game.keys.right) moveX = 5;
  if (game.keys.up) moveY = -5;
  if (game.keys.down) moveY = 5;
  if (game.touch.active) {
    moveX = (game.touch.currentX - game.touch.startX) * 0.1;
  }
  
  game.player.x += moveX + game.windForce;
  game.player.x = Math.max(30, Math.min(game.width - 30, game.player.x));
  
  // ìœ„ì•„ë˜ ì´ë™ (ìƒìŠ¹/ë‚™í•˜ Phase)
  if (game.phase === 'rising' || game.phase === 'falling') {
    game.player.y += moveY;
    game.player.y = Math.max(50, Math.min(game.height - 50, game.player.y));
  }
  
  // Phaseë³„ ì—…ë°ì´íŠ¸
  switch (game.phase) {
    case 'rising':
      updateRising(elapsed);
      break;
    case 'bond':
      updateBond(elapsed);
      break;
    case 'growth':
      updateGrowth(elapsed);
      break;
    case 'falling':
      updateFalling(elapsed);
      break;
  }
  
  // íŒŒí‹°í´ ì—…ë°ì´íŠ¸
  game.particles.forEach((p, i) => {
    p.x += p.vx || 0;
    p.y += p.vy || 0;
    p.life--;
    
    // ì—ë„ˆì§€ ìˆ˜ì§‘
    if (p.type === 'energy' && game.phase === 'rising') {
      const dist = Math.hypot(p.x - game.player.x, p.y - game.player.y);
      if (dist < 40) {
        game.energy++;
        game.score += 10;
        p.life = 0;
        game.particles.push(createEnergyParticle());
      }
    }
  });
  game.particles = game.particles.filter(p => p.life > 0);
  
  // UI ì—…ë°ì´íŠ¸
  document.getElementById('altitude').textContent = Math.floor(game.altitude);
  document.getElementById('score').textContent = game.score;
}

function updateRising(elapsed) {
  const progress = Math.min(elapsed / CONFIG.PHASE_RISING.duration, 1);
  game.altitude = progress * CONFIG.PHASE_RISING.maxAltitude;
  document.getElementById('progressFill').style.width = `${progress * 100}%`;
  
  // ì¥ì• ë¬¼ ì´ë™ ë° ì¶©ëŒ
  game.obstacles.forEach(obs => {
    obs.x += obs.vx;
    if (obs.x < 0 || obs.x > game.width) obs.vx *= -1;
    
    const dist = Math.hypot(obs.x - game.player.x, obs.y - game.player.y);
    if (dist < 40) {
      game.score = Math.max(0, game.score - 50);
      obs.y = -100; // ì œê±°
    }
  });
  
  // Phase ì „í™˜
  if (progress >= 1) {
    startBondPhase();
  }
}

function updateBond(elapsed) {
  const progress = Math.min(elapsed / CONFIG.PHASE_BOND.duration, 1);
  document.getElementById('progressFill').style.width = `${progress * 100}%`;
  
  // ë¨¼ì§€ ì´ë™
  game.dustParticles.forEach(d => {
    d.x += d.vx;
    if (d.x < 30 || d.x > game.width - 30) d.vx *= -1;
  });
  
  // ì‹œê°„ ì´ˆê³¼ì‹œ ìë™ ê²°í•©
  if (progress >= 1 && game.phase === 'bond') {
    game.bondBonus = 100;
    showPhaseIndicator('ê²°í•© ì™„ë£Œ');
    game.player.form = 'crystal';
    startGrowthPhase();
  }
}

function updateGrowth(elapsed) {
  const progress = Math.min(elapsed / CONFIG.PHASE_GROWTH.duration, 1);
  document.getElementById('progressFill').style.width = `${progress * 100}%`;
  
  // ì£¼ë³€ ìˆ˜ì¦ê¸° í¡ìˆ˜ íš¨ê³¼
  if (Math.random() < 0.1) {
    game.particles.push({
      x: game.player.x + (Math.random() - 0.5) * 200,
      y: game.player.y + (Math.random() - 0.5) * 200,
      vx: (game.player.x - (game.player.x + (Math.random() - 0.5) * 200)) * 0.02,
      vy: (game.player.y - (game.player.y + (Math.random() - 0.5) * 200)) * 0.02,
      life: 60,
      type: 'vapor',
    });
  }
  
  if (progress >= 1) {
    startFallingPhase();
  }
}

function updateFalling(elapsed) {
  const progress = Math.min(elapsed / CONFIG.PHASE_FALLING.duration, 1);
  document.getElementById('progressFill').style.width = `${progress * 100}%`;
  
  // ë‚™í•˜
  game.player.y += 3;
  game.altitude = 5000 * (1 - progress);
  
  // ë°”ëŒ
  game.windForce = Math.sin(elapsed * 0.002) * 2;
  
  // ì°©ì§€ í™•ì¸
  if (game.player.y > game.height - 100) {
    const zones = ['mountain', 'lake', 'forest', 'village'];
    const zoneWidth = game.width / 4;
    const zoneIndex = Math.floor(game.player.x / zoneWidth);
    endGame(zones[Math.min(zoneIndex, 3)]);
  }
}

// ============== ë Œë”ë§ ==============
function render() {
  const ctx = game.ctx;
  
  // ë°°ê²½
  renderBackground(ctx);
  
  if (game.phase === 'title' || game.phase === 'episode' || game.phase === 'result') return;
  
  // íŒŒí‹°í´
  game.particles.forEach(p => renderParticle(ctx, p));
  
  // ì¥ì• ë¬¼
  if (game.phase === 'rising') {
    game.obstacles.forEach(obs => renderObstacle(ctx, obs));
  }
  
  // ë¨¼ì§€
  if (game.phase === 'bond') {
    game.dustParticles.forEach(d => renderDust(ctx, d));
  }
  
  // ì°©ì§€ ì¡´
  if (game.phase === 'falling') {
    renderLandingZones(ctx);
  }
  
  // í”Œë ˆì´ì–´
  renderPlayer(ctx);
}

function renderBackground(ctx) {
  let gradient;
  
  if (game.phase === 'title' || game.phase === 'episode' || game.phase === 'result') {
    return;
  }
  
  // ê³ ë„ì— ë”°ë¥¸ ë°°ê²½ ë³€í™”
  if (game.altitude < 2000) {
    gradient = ctx.createLinearGradient(0, 0, 0, game.height);
    gradient.addColorStop(0, '#87CEEB');
    gradient.addColorStop(0.7, '#E0F4FF');
    gradient.addColorStop(1, '#1e90ff');
  } else if (game.altitude < 4000) {
    gradient = ctx.createLinearGradient(0, 0, 0, game.height);
    gradient.addColorStop(0, '#4a90d9');
    gradient.addColorStop(1, '#87CEEB');
  } else {
    gradient = ctx.createLinearGradient(0, 0, 0, game.height);
    gradient.addColorStop(0, '#1a365d');
    gradient.addColorStop(0.5, '#2c5282');
    gradient.addColorStop(1, '#4a90d9');
  }
  
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, game.width, game.height);
  
  // êµ¬ë¦„
  if (game.altitude > 3000 || game.phase === 'growth') {
    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    for (let i = 0; i < 5; i++) {
      const x = (Date.now() * 0.01 + i * 100) % (game.width + 100) - 50;
      ctx.beginPath();
      ctx.arc(x, 80 + i * 30, 40, 0, Math.PI * 2);
      ctx.arc(x + 30, 80 + i * 30, 30, 0, Math.PI * 2);
      ctx.arc(x - 30, 80 + i * 30, 30, 0, Math.PI * 2);
      ctx.fill();
    }
  }
}

function renderParticle(ctx, p) {
  ctx.save();
  ctx.globalAlpha = Math.min(1, p.life / 30);
  
  if (p.type === 'energy') {
    ctx.fillStyle = '#FFD700';
    ctx.beginPath();
    ctx.arc(p.x, p.y, 8, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#FFF';
    ctx.beginPath();
    ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
    ctx.fill();
  } else if (p.type === 'vapor') {
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.beginPath();
    ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
    ctx.fill();
  } else if (p.type === 'sparkle') {
    ctx.fillStyle = '#5eb8ff';
    ctx.beginPath();
    ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
    ctx.fill();
  }
  
  ctx.restore();
}

function renderObstacle(ctx, obs) {
  ctx.font = '30px Arial';
  ctx.textAlign = 'center';
  
  if (obs.type === 'bird') ctx.fillText('ğŸ¦', obs.x, obs.y);
  else if (obs.type === 'plane') ctx.fillText('âœˆï¸', obs.x, obs.y);
  else ctx.fillText('ğŸ’¨', obs.x, obs.y);
}

function renderDust(ctx, d) {
  ctx.beginPath();
  ctx.arc(d.x, d.y, d.quality === 'perfect' ? 20 : 15, 0, Math.PI * 2);
  ctx.fillStyle = d.quality === 'perfect' ? '#FFD700' : '#666';
  ctx.fill();
  
  if (d.quality === 'perfect') {
    ctx.strokeStyle = '#FFF';
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.font = '12px Arial';
    ctx.fillStyle = '#FFF';
    ctx.textAlign = 'center';
    ctx.fillText('â˜…', d.x, d.y + 4);
  }
}

function renderLandingZones(ctx) {
  const zones = [
    { emoji: 'ğŸ”ï¸', name: 'ì‚°', color: '#666' },
    { emoji: 'ğŸŒŠ', name: 'í˜¸ìˆ˜', color: '#1e90ff' },
    { emoji: 'ğŸŒ²', name: 'ìˆ²', color: '#228B22' },
    { emoji: 'ğŸ ', name: 'ë§ˆì„', color: '#8B4513' },
  ];
  
  const zoneWidth = game.width / 4;
  zones.forEach((zone, i) => {
    ctx.fillStyle = zone.color;
    ctx.fillRect(i * zoneWidth, game.height - 60, zoneWidth, 60);
    
    ctx.font = '30px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(zone.emoji, i * zoneWidth + zoneWidth / 2, game.height - 25);
  });
}

function renderPlayer(ctx) {
  ctx.save();
  ctx.translate(game.player.x, game.player.y);
  
  if (game.player.form === 'drop') {
    // ë¬¼ë°©ìš¸
    ctx.fillStyle = '#4FC3F7';
    ctx.beginPath();
    ctx.arc(0, 0, 20, 0, Math.PI * 2);
    ctx.fill();
    // ëˆˆ
    ctx.fillStyle = '#000';
    ctx.beginPath();
    ctx.arc(-6, -3, 3, 0, Math.PI * 2);
    ctx.arc(6, -3, 3, 0, Math.PI * 2);
    ctx.fill();
    // ì…
    ctx.beginPath();
    ctx.arc(0, 5, 5, 0, Math.PI);
    ctx.stroke();
  } else if (game.player.form === 'vapor') {
    // ìˆ˜ì¦ê¸°
    ctx.fillStyle = 'rgba(255,255,255,0.7)';
    ctx.beginPath();
    ctx.arc(0, 0, 15, 0, Math.PI * 2);
    ctx.arc(-10, 5, 10, 0, Math.PI * 2);
    ctx.arc(10, 5, 10, 0, Math.PI * 2);
    ctx.fill();
    // ëˆˆ
    ctx.fillStyle = '#333';
    ctx.beginPath();
    ctx.arc(-5, -2, 2, 0, Math.PI * 2);
    ctx.arc(5, -2, 2, 0, Math.PI * 2);
    ctx.fill();
  } else if (game.player.form === 'crystal' || game.player.form === 'snowflake') {
    // ëˆˆì†¡ì´
    ctx.strokeStyle = '#FFF';
    ctx.lineWidth = 2;
    
    // ê¸°ë³¸ 6ê° êµ¬ì¡°
    for (let i = 0; i < 6; i++) {
      ctx.save();
      ctx.rotate((i * 60 * Math.PI) / 180);
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(0, -25 - game.snowflake.size * 0.5);
      ctx.stroke();
      
      // ê°€ì§€
      if (game.snowflake.size > 10) {
        ctx.beginPath();
        ctx.moveTo(0, -15);
        ctx.lineTo(-8, -22);
        ctx.moveTo(0, -15);
        ctx.lineTo(8, -22);
        ctx.stroke();
      }
      ctx.restore();
    }
    
    // ì¶”ê°€ ê°€ì§€ë“¤
    game.snowflake.branches.forEach((b, idx) => {
      ctx.save();
      ctx.rotate((b.angle * Math.PI) / 180);
      ctx.beginPath();
      ctx.moveTo(0, -10 - idx * 2);
      ctx.lineTo(0, -10 - idx * 2 - b.length);
      ctx.stroke();
      ctx.restore();
    });
    
    // ì¤‘ì‹¬ ë¹›
    ctx.fillStyle = 'rgba(255,255,255,0.8)';
    ctx.beginPath();
    ctx.arc(0, 0, 5, 0, Math.PI * 2);
    ctx.fill();
  }
  
  ctx.restore();
}

// ============== ê²Œì„ ë£¨í”„ ==============
function gameLoop() {
  update();
  render();
  game.animationId = requestAnimationFrame(gameLoop);
}

// ì‹œì‘
window.addEventListener('load', init);
</script>
</body>
</html>
